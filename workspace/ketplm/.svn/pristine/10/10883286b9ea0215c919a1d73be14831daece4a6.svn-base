<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@page import="e3ps.common.util.CommonUtil"%>
<%@ taglib prefix="ket" uri="ext.ket.shared.tld"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<jsp:useBean id="messageService" class="e3ps.common.message.KETMessageService" scope="session" />
<!-- callServer function 사용시 include -->
<%@include file="/jsp/project/template/ajaxProgress.html"%>
<script type="text/javascript" src="/plm/extcore/js/issue/issue.js"></script>
<script src="/plm/extcore/js/shared/commonGrid.js"></script>
<script src="/plm/portal/js/treegrid/GridE.js"></script>
<script src="/plm/portal/js/treegrid/Grid_KET_T.js"></script>
<style>
html{width:100%;height:100%;}
</style>
<script type="text/javascript">
$(document).ready(function(e) {
    
    issue.createPaingGrid();
    issue.createTaskPaingGrid();
    
    CommonUtil.singleSelect('issueState',130);
    CommonUtil.singleSelect('issueTaskState',130);
    CommonUtil.singleSelect('reqCode',130);
    CommonUtil.multiSelect('detailCode',130);
    
    CalendarUtil.dateInputFormat('requestStartDate'); //requestStartDate
    CalendarUtil.dateInputFormat('requestEndDate'); //requestEndDate
    
    CalendarUtil.dateInputFormat('sopStartDate'); //sopStartDate
    CalendarUtil.dateInputFormat('sopEndDate'); //sopEndDate

    SuggestUtil.bind('USERDEPT', 'managerName', 'managerOid');
    SuggestUtil.bind('USERDEPT', 'tmUserName', 'tmUserOid');
    
    SuggestUtil.bind('DEPARTMENT', 'deptName', 'deptCode');
    SuggestUtil.bind('DEPARTMENT', 'taskDeptName', 'taskDeptCode');
    
    //SuggestUtil.bind('CUSTOMEREVENT', 'lastCustomerName', 'lastCustomer');
    SuggestUtil.bind('CARTYPE', 'oemName', 'oemOid');
    SuggestUtil.bind('PRODUCTPARTNO', 'partNos');
    
    $("select[name=issueTaskState]").change(function(){
        
        var value = $(this).val();
        
        if(value == "IST002") $(".delayState").show();
        else                  $(".delayState").hide();
    });
    
    window.activeTabFlag = "ISSUEMASTER";
    
    if(!${isSalesAuth}) window.activeTabFlag = "ISSUETASK";
    
    if("ISSUETASK" == activeTabFlag){
        $(".taskTD").show();
        $(".masterTD").hide();
    }else{
        $(".masterTD").show();
        $(".taskTD").hide();
    }
    
    var tab = null;
    if(window.activeTabFlag == "ISSUETASK") {
        tab = CommonUtil.tabs('tabs', 1);
         $('.tabContent').hide();
         $('.tabContent :eq(1)').show();
    }else {
        tab = CommonUtil.tabs('tabs');
         $('.tabContent').hide();
         $('.tabContent :first').show();
    }
    
    var isGridLoad = false;
    
    $(".tabref").click(function(){
        $(".tabContent").hide();
        var ref = $(this).attr("href");
        window.activeTabFlag = $(ref).attr("id");
        
        $(ref).show(0, function(){
            if("ISSUETASK" == activeTabFlag && !isGridLoad){
                Grids['taskSearchGrid'].Update(); 
                isGridLoad = true;
            }else if(!isGridLoad){
                Grids['searchGrid'].Update(); 
                isGridLoad = true;
            }
        });
        
        if("ISSUETASK" == activeTabFlag){
            $(".taskTD").show();
            $(".masterTD").hide();
        }else{
            $(".masterTD").show();
            $(".taskTD").hide();
        }
    });
    
    
    $(document).bind('keypress', function(e) {
        if (e.which == 13) {
            if("ISSUETASK" == activeTabFlag){
                issue.searchTask();
            }else{
                issue.search();
            }
        }
    });
    
    
    Grids.OnDownloadPage = function(grid,row){
        grid.Data.Page.Format = 'Form';
        grid.Data.Page.Method = 'Post';
        
        if("ISSUETASK" == activeTabFlag){
            grid.Data.Page.Url = '/plm/ext/issue/findTaskPagingList.do?sortName=*Sort0';
        }else{
            grid.Data.Page.Url = '/plm/ext/issue/findPagingList.do?sortName=*Sort0';
        }
        
        var param = {
            page : grid.GetPageNum(row),
            formPage : grid.Source.Layout.Data.Cfg.PageLength
        }

        $('input,select').each(function(){
            var name = $(this).attr('name');
            var value = $(this).val();
            param[name] = value;
        });
        grid.Data.Page.Param = param;
    }
    
    $("#reqCode").change(function(){
        
        issue.initDetailCode($(this).val());

    });
    
    treeGridResize("#searchGrid","#listGrid");//크롬에서 그리드 리사이즈 하기 위한 코드 param1 : grid Id, param2 : divId
    treeGridResize("#taskSearchGrid","#taskListGrid");//크롬에서 그리드 리사이즈 하기 위한 코드 param1 : grid Id, param2 : divId
    
});

window.issueSearch = function(){
    
    if("ISSUETASK" == activeTabFlag){
        issue.searchTask();
    }else{
        issue.search();
    }
}

window.setSubContractor = function(data){
    
    var nodeCodeStr='', nodeNameStr='';
    
    window.console.log(data);
    
    for(var i=0; i < data.length; i++){
        if(i == data.length - 1){
            nodeCodeStr += data[i][1];
            nodeNameStr += data[i][2];
        }else{
            nodeCodeStr += data[i][1]+',';     
            nodeNameStr += data[i][2]+',';
        }
    }
    $('[name=subContractorName]').val(nodeNameStr);
    $('[name=subContractor]').val(nodeCodeStr);
}

function selectMultiSubContractor(returnValue){
    var nodeIdStr='', nodeNameStr='';
    for(var i=0; i < returnValue.length; i++){
            if(i == returnValue.length - 1){
                    nodeIdStr += returnValue[i][0];
                    nodeNameStr += returnValue[i][2];
            }else{
                    nodeIdStr += returnValue[i][0]+',';     
                    nodeNameStr += returnValue[i][2]+',';
            }
    }
    $('[name=customerCode]').val(nodeIdStr);
    $('[name=customerName]').val(nodeNameStr);
}

function addDepartment(codeTarget, nameTarget) {
    
    window.deptTagetName = nameTarget;
    window.deptTagetCode = codeTarget;
    
    var url = "/plm/jsp/project/AddProjectDeptFrm.jsp?mode=s";
    attacheDept = window.showModalDialog(url,window,"help=no; resizable=yes; status=no; scroll=no; dialogWidth=430px; dialogHeight:465px; center:yes");
    if(typeof attacheDept == "undefined" || attacheDept == null) {
        return;
    }

    if ( typeof(attacheDept) != "object" ) {
        var deptSplit = attacheDept.split(",");
        for ( var i=0; i<deptSplit.length-1; i++ ) {
            var param = "command=deptInfo&deptOid=" + deptSplit[i];
            var url = "/plm/jsp/project/ProjectGroupWareAjaxAction.jsp?" + param;
            callServer(url, acceptDept);
        }
    }
    else {
        var param = "command=deptInfo&deptOid=" + attacheDept[0][0];
        var url = "/plm/jsp/project/ProjectGroupWareAjaxAction.jsp?" + param;
        callServer(url, acceptDept);
    }
}

function acceptDept(req) {
    
    var xmlDoc = req.responseXML;
    var showElements = xmlDoc.selectNodes("//message");
    var msg = showElements[0].getElementsByTagName("l_message")[0].text;
    
    if(msg != 'true') {
        alert('<%=messageService.getString("e3ps.message.ket_message", "01184") %><%--다시 시도하시기 바랍니다--%>');
        return;
    }

    showElements = xmlDoc.selectNodes("//data_info");
    var l_oid = showElements[0].getElementsByTagName("l_oid");
    var l_name = showElements[0].getElementsByTagName("l_name");
    var l_code = showElements[0].getElementsByTagName("l_code");
    var l_chiefOid = showElements[0].getElementsByTagName("l_chiefOid");
    var l_chiefName = showElements[0].getElementsByTagName("l_chiefName");

    $("#" + deptTagetCode).val( decodeURIComponent(l_code[0].text) );
    $("#" + deptTagetName).val( decodeURIComponent(l_name[0].text) );
}

function delDepartment(targetId, targetName) {
    $("#" + targetId).val("");
    $("#" + targetName).val("");
}
window.openIssueSave = function(){
    getOpenWindow2("/plm/ext/issue/saveIssuePopup", "IssuePopup", 1280, 720);
}

function selectPartAfterFunc( objArr )
{
    var trArr;
    if(objArr.length == 0) {
        return;
    }
    for(var i = 0; i < objArr.length; i++)
    {
        setPart(objArr[i]);
    }
}

function setPart(objArr){
    trArr = objArr;
    var tempRelatedPartOid = $('[name=relatedPartOid]').val();
    var tempRelatedPart = $('[name=partNos]').val();
    
    if(tempRelatedPartOid != ""){
        tempRelatedPartOid = tempRelatedPartOid+",";
    }
    if(tempRelatedPart != ""){
        tempRelatedPart = tempRelatedPart+",";
    }
    
    $('[name=relatedPartOid]').val(tempRelatedPartOid+trArr[0]);
    $('[name=partNos]').val(tempRelatedPart+trArr[1]);
}

</script>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
    <tr>
        <td><table width="100%" height="28" border="0" cellspacing="0" cellpadding="0">
                <tr>
                    <td width="20"><img src="/plm/portal/images/icon_3.png"></td>
                    <td class="font_01">고객/사내 요구사항 검색
                    <iframe id="download" name="download" src="#" style="width:0px;height:0px;border:0px;"></iframe>
                    <a href="/plm/ext/dms/redirectSG/SG-18-001/DOWN" download target="download"><!-- 시스템가이드 링크 -->
                        <img src="/plm/portal/images/exclamation.png" class="detailInfo" style="cursor:pointer;" title="정보를 보려면 클릭하세요." />
                    </a>
                    <c:if test="${ket:isAdmin() }">
                    <a href="#" onClick="javascript:getOpenWindow2('/plm/ext/dms/redirectSG/SG-18-001/VIEW', 'SGDocumentPopup', 800, 450);"><!-- 시스템가이드 팝업 -->
                        <img src="/plm/extcore/extjs50/packages/ext-theme-classic/build/resources/images/tree/leaf.gif" title="시스템 가이드 문서 상세정보">
                    </a>
                    </c:if>
                    </td>
                    <td align="right">
                    <img src="/plm/portal/images/icon_navi.gif">HOME
                    <img src="/plm/portal/images/icon_navi.gif">Project
                    <img src="/plm/portal/images/icon_navi.gif">영업
                    <img src="/plm/portal/images/icon_navi.gif">고객대응관리
                    </td>
                </tr>
            </table></td>
    </tr>
    <tr>
        <td class="head_line"></td>
    </tr>
    <tr>
        <td class="space5"></td>
    </tr>
</table>
<!-- [START] search condition -->
<div id="tabs" style="margin:0 auto;">
    <ul>
        <li><a class="tabref" href="#ISSUEMASTER">요청서</a></li>
        <li><a class="tabref" href="#ISSUETASK">세부진행항목</a></li>
    </ul>
    <div class="float-r" style="position:relative;top:-30px;">
       <%-- <c:if test="${isSalesAuth }"> --%>
       <span class="in-block v-middle r-space7">
            <span class="pro-table">
                <span class="pro-cell b-left"></span>
                <span class="pro-cell b-center">
                    <a href="javascript:openIssueSave();" class="btn_blue">
                    등록
                    </a>
                </span>
                <span class="pro-cell b-right"></span>
            </span>
        </span>
        <%-- </c:if> --%>
       <span class="in-block v-middle r-space7">
            <span class="pro-table">
                <span class="pro-cell b-left"></span>
                <span class="pro-cell b-center">
                    <a href="javascript:issue.clear();" class="btn_blue">
                    <%=messageService.getString("e3ps.message.ket_message", "02819") %><%--초기화--%>
                    </a>
                </span>
                <span class="pro-cell b-right"></span>
            </span>
        </span>
        <span class="in-block v-middle r-space7">
            <span class="pro-table">
                <span class="pro-cell b-left"></span>
                <span class="pro-cell b-center">
                    <a href="javascript:issueSearch();" class="btn_blue"><%=messageService.getString("e3ps.message.ket_message", "00705")%><%--검색--%></a>
                </span>
                <span class="pro-cell b-right"></span>
            </span>
        </span>
    </div>
    <form name="searchForm">
        <!-- 검색영역 collapse/expand -->
        <div id="collapseDiv" align="center" style="position:relative;top:-5px;">
            <img src="/plm/extcore/extjs50/build/packages/ext-theme-classic/build/resources/images/layout/mini-top.gif" class="collapseIcon">
        </div>
        <table style="width: 100%;position:relative;top:-24px;">
            <tr>
                <td class="tab_btm2"></td>
            </tr>
        </table>
        <table style="width:100%;position:relative;top:-24px;">
            <colgroup>
                <col width="10%" />
                <col width="15%" />
                <col width="10%" />
                <col width="15%" />
                <col width="10%" />
                <col width="15%" />
                <col width="10%" />
                <col width="15%" />
            </colgroup>
            <tr>
                <!-- <td class="tdblueL">Project No</td>
                <td class="tdwhiteL">
                    <input type="text" name="pboNo" style="width: 70%" class="txt_field" value="">
                    <input type="hidden" name="pboOid" value="">
                    <a href="javascript:SearchUtil.selectOneSalesProject('issue.setPboNo');">
                        <img src="/plm/portal/images/icon_5.png" border="0">
                    </a>
                    <a href="javascript:CommonUtil.deleteValue('pboNo','pboOid');">
                        <img src="/plm/portal/images/icon_delete.gif" border="0">
                    </a>
                </td>
                <td class="tdblueL">프로젝트명</td>
                <td class="tdwhiteL">
                    <input type="text" name="pboName" class="txt_field" style="width: 70%" value=""></td> -->
                
                <td class="tdblueL"><%=messageService.getString("e3ps.message.ket_message", "09005") %><%--부품 NO--%></td>
                <td class="tdwhiteL">
                    <input type="text" name="partNos" class="txt_field" style="width: 70%">
                    <input type="hidden" name="relatedPartOid">
                    <a href="javascript:showProcessing();SearchUtil.selectPart('selectPartAfterFunc','pType=');">
                    <img src="/plm/portal/images/icon_5.png" border="0"></a> 
                    <a href="javascript:CommonUtil.deleteValue('partNos', 'relatedPartOid');">
                    <img src="/plm/portal/images/icon_delete.gif" border="0"></a></td>
                </td>
                
                <td class="tdblueL">상세구분<span class="red">*</span></td>
                <td class="tdwhiteL">
                    <ket:select id="reqCode" name="reqCode" className="fm_jmp" codeType="ISSUEREQ" multiple="multiple" useCodeValue="true" value=""  />
                    <ket:select id="detailCode" name="detailCode" className="fm_jmp" codeType="" multiple="multiple" useCodeValue="true" value=""  />
                </td>
                
                <td class="tdblueL">요청부서</td>
                <td class="tdwhiteL">
                    <input style="width: 70%;" type="text" id="deptName" name="deptName" class="txt_field" value="">
                    <input type=hidden id="deptCode" name="deptCode" value="">
                    <a href="javascript:addDepartment('deptCode', 'deptName');">
                        <img src="/plm/portal/images/icon_5.png">
                    </a>
                    <a href="javascript:delDepartment('deptCode', 'deptName');">
                    <img src="/plm/portal/images/icon_delete.gif">
                    </a>
                </td>
            </tr>
            <tr>
                <td class="tdblueL">자동차사</td>
                <td class="tdwhiteL">
                    <input type="text" name="lastCustomerName" style="width: 70%;" class="txt_field" value="">
                    <input type="hidden" name="lastCustomer" value="">
                    <a href="javascript:SearchUtil.selectOneLastUsingBuyerCode('lastCustomer','lastCustomerName');">
                        <img src="/plm/portal/images/icon_5.png" border="0">
                    </a>
                    <a href="javascript:CommonUtil.deleteValue('lastCustomer','lastCustomerName');">
                        <img src="/plm/portal/images/icon_delete.gif" border="0">
                    </a>
                </td>
                <td class="tdblueL">고객사</td>
                <td class="tdwhiteL">
                    <input type="text" name="subContractorName" style="width: 70%;" class="txt_field" value="">
                    <input type="hidden" name="subContractor" value="">
                    <a href="javascript:SearchUtil.selectMultiSubContractor(setSubContractor);">
                        <img src="/plm/portal/images/icon_5.png" border="0">
                    </a>
                    <a href="javascript:CommonUtil.deleteValue('subContractorName','subContractor');">
                        <img src="/plm/portal/images/icon_delete.gif" border="0">
                    </a>
                </td>
                <td class="tdblueL">대표차종</td>
                <td class="tdwhiteL">
                    <input type="text" name="oemName" style="width: 70%;" class="txt_field" value="">
                    <input type="hidden" name="oemOid" value="">
                    <a href="javascript:SearchUtil.selectCarType('oemOid','oemName');">
                        <img src="/plm/portal/images/icon_5.png" border="0">
                    </a>
                    <a href="javascript:CommonUtil.deleteValue('oemOid','oemName');">
                        <img src="/plm/portal/images/icon_delete.gif" border="0">
                    </a>
                </td>
            <tr>
                <td class="tdblueL">요청자</td>
                <td class="tdwhiteL">
                    <input type="text" name="managerName" style="width: 70%;" class="txt_field" value="">
                    <input type="hidden" name="managerOid" value="">
                    <a href="javascript:SearchUtil.selectOneUser('managerOid','managerName');">
                        <img src="/plm/portal/images/icon_user.gif" border="0">
                    </a>
                    <a href="javascript:CommonUtil.deleteValue('managerOid','managerName');">
                        <img src="/plm/portal/images/icon_delete.gif" border="0">
                    </a>
                </td>
                <td class="tdblueL">세부 담당자</td>
                <td class="tdwhiteL">
                    <input type="text" name="tmUserName" style="width: 70%;" class="txt_field" value="">
                    <input type="hidden" name="tmUserOid" value="">
                    <a href="javascript:SearchUtil.selectOneUser('tmUserOid','tmUserName');">
                        <img src="/plm/portal/images/icon_user.gif" border="0">
                    </a>
                    <a href="javascript:CommonUtil.deleteValue('tmUserOid','tmUserName');">
                        <img src="/plm/portal/images/icon_delete.gif" border="0">
                    </a>
                </td>
                <td class="tdblueL masterTD">요청서 상태</td>
                <td class="tdwhiteL masterTD">
                    <ket:select id="issueState" name="issueState" className="fm_jmp" codeType="ISSUESTATE" multiple="multiple" useNullValue="true" useCodeValue="true" />
                </td>
                <td class="tdblueL taskTD">세부 담당부서</td>
                <td class="tdwhiteL taskTD">
                    <input style="width: 70%;" type="text" id="taskDeptName" name="taskDeptName" class="txt_field" value="${deptName }">
                    <input type=hidden id="taskDeptCode" name="taskDeptCode" value="${deptOid }">
                    <a href="javascript:addDepartment('taskDeptCode', 'taskDeptName');">
                        <img src="/plm/portal/images/icon_5.png">
                    </a>
                    <a href="javascript:delDepartment('taskDeptCode','taskDeptName');">
                    <img src="/plm/portal/images/icon_delete.gif">
                    </a>
                </td>
            </tr>
            <tr>
                <td class="tdblueL">등록일자</td>
                <td class="tdwhiteL">
                    <input type="text" name="requestStartDate" class="txt_field" style="width: 70px;" value="">
                    <a href="javascript:CommonUtil.deleteValue('requestStartDate');">
                        <img src="/plm/portal/images/icon_delete.gif" border="0">
                    </a>~ 
                    <input type="text" name="requestEndDate" class="txt_field" style="width: 70px;" value="">
                    <a href="javascript:CommonUtil.deleteValue('requestEndDate');">
                        <img src="/plm/portal/images/icon_delete.gif" border="0">
                    </a>
                </td>
                <td class="tdblueL masterTD">SOP</td>
                <td class="tdwhiteL masterTD">
                    <input type="text" name="sopStartDate" class="txt_field" style="width: 70px;" value="">
                    <a href="javascript:CommonUtil.deleteValue('sopStartDate');">
                        <img src="/plm/portal/images/icon_delete.gif" border="0">
                    </a>~ 
                    <input type="text" name="sopEndDate" class="txt_field" style="width: 70px;" value="">
                    <a href="javascript:CommonUtil.deleteValue('sopEndDate');">
                        <img src="/plm/portal/images/icon_delete.gif" border="0">
                    </a>
                </td>
                <td class="tdblueL taskTD">세부항목 상태</td>
                <td class="tdwhiteL taskTD">
                    <ket:select id="issueTaskState" name="issueTaskState" className="fm_jmp" codeType="ISSUESTATE" multiple="multiple" useNullValue="true" value="IST002" useCodeValue="true" />
                    <label class="delayState" style="font-weight:bold;color:#FF0000;"><input type="checkbox" name="delayState" value="true" />지연</label>
                </td>
                <th class="tdwhiteL" colspan="2"></th>
            </tr>
        </table>
    </form>
    
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
            <td align="right">
                <table border="0" cellspacing="0" cellpadding="0" width="100%">
                    <tr>
                       <td class="space5"></td>
                    </tr>
                </table> <!-- EJS TreeGrid Start -->
                <div class="content-main">
                    <div class="container-fluid">
                        <div class="row-fluid">
                            <div id="ISSUEMASTER" class="tabContent" style="border: 0; border-radius: 0;padding-top:0 !important;">
                                <div id="listGrid" style="WIDTH: 100%; HEIGHT: 100%; min-height:200px"></div>
                            </div>
                            <div id="ISSUETASK" class="tabContent" style="border: 0; border-radius: 0;padding-top:0 !important;">
                                <div id="taskListGrid" style="WIDTH: 100%; HEIGHT: 100%; min-height:200px"></div>
                            </div>
                        </div>
                    </div>
                <!-- EJS TreeGrid Start -->
                </div>
            </td>
        </tr>
    </table>
</div>